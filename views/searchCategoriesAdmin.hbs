<div class="container d-flex flex-column">
  <form id="searchForm"  action="/admin" method="GET">
    <div class="row gap-3">
      <input
        type="text"
        class="col-7 form-control"
        placeholder="TÃ¬m kiáº¿m báº±ng tÃªn thá»ƒ loáº¡i"
        name="keyCategoryName"
        value= "{{ValueName}}"
      />
      <button type="submit" class="col btn btn-success">Tra cá»©u</button>
    </div>
  </from>

  <div class="query-result mt-5">
    <h5 class="text-center mb-3">Káº¾T QUáº¢ TRA Cá»¨U</h5>
    <table class="table">
      <thead>
        <tr>
          <th scope="col">#ID</th>
          <th scope="col">TÃªn thá»ƒ loáº¡i</th>
          <th scope="col">Sá»‘ sáº£n pháº©m</th>
          <th scope="col">XÃ³a</th>
          <th scope="col">Chá»‰nh sá»­a</th>
        </tr>
      </thead>
      <tbody>
         {{#each _Categories}}
          <tr id = {{this.CategoryID}}>
            <th scope="row" >{{this.CategoryID}}</th>
            <td>{{this.CategoryName}}</td>
            <td>{{this.CategoryQuantity}}</td>
            <td>
              <button class="btn-delete" data-category-id="{{this.CategoryID}}">
                <i class="fas fa-trash"></i> 
              </button></td>
             <td>
              <button class="btn-edit" data-category-id="{{this.CategoryID}}">
                <i class="fas fa-edit"></i> 
              </button>
            </td>
          </tr>
        {{else}}
          <td colspan="6" class="text-center">KhÃ´ng TÃ¬m Tháº¥y SÃ¡ch Theo YÃªu Cáº§uðŸ¥²</td>
        {{/each}}
      </tbody>
    </table>
  </div>
  <div class="d-flex justify-content-center">
    {{#if pages}}
    <select class="col-2 align-self-center paging form-select">
      {{#each pages}}
      <option value="{{this}}">Page {{this}}</option>
      {{/each}}
    </select>
    {{/if}}
  </div>
</div>
<script>
// Update Page
const selection = document.querySelector(".paging");
selection?.addEventListener("change", (e) => {
  const url = new URL(window.location.href);
  const query = new URLSearchParams(window.location.search);
  query.set("page", e.target.value);
  url.search = query;
  location.assign(url.href);
});
const query = new URLSearchParams(window.location.search);
if (selection) selection.value = query.get("page") || 1;

// Delete vs ajax
document.querySelectorAll('.btn-delete').forEach(button => {
  button.addEventListener('click', function() {
    event.preventDefault();
    const categoryId = this.getAttribute('data-category-id');
    const deleteUrl = `/admin/categories/delete/${categoryId}`;
    // Sá»­ dá»¥ng AJAX Ä‘á»ƒ gá»­i yÃªu cáº§u DELETE
    const xhr = new XMLHttpRequest();
    xhr.open('DELETE', deleteUrl, true);

    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        console.log(xhr.status);
        if (xhr.status === 200) {
          // Xá»­ lÃ½ thÃ nh cÃ´ng
          updateUI(categoryId);
          console.log('Dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c xÃ³a thÃ nh cÃ´ng!');
        } else {
          // Xá»­ lÃ½ lá»—i
          console.error('Lá»—i xÃ³a dá»¯ liá»‡u:', xhr.statusText);
        }
      }
    };
    xhr.send();
  });
});
//Update giao diá»‡n
function updateUI(categoryId) {
    // Láº¥y tham chiáº¿u Ä‘áº¿n pháº§n tá»­ trá»±c tiáº¿p báº±ng id
    const rowToRemove = document.getElementById(categoryId);
    // Kiá»ƒm tra xem cÃ³ pháº§n tá»­ Ä‘á»ƒ loáº¡i bá» khÃ´ng
    if (rowToRemove) {
      // Loáº¡i bá» hÃ ng tá»« DOM
      rowToRemove.remove();
    } else {
      console.error('KhÃ´ng tÃ¬m tháº¥y hÃ ng Ä‘á»ƒ loáº¡i bá».');
    }
}


// Edit
document.querySelectorAll('.btn-edit').forEach(button => {
  button.addEventListener('click', function() {
    event.preventDefault();
    const categoryId = this.getAttribute('data-category-id');
    window.location.href = `/admin/categories/edit/${categoryId}`;
  });
});
</script>
